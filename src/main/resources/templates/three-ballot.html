<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/three-ballot.css">
    <title>Three Ballot Voting System</title>
    <script>
        function finalizeCandidate() {
            // Disable all checkboxes
            const ballotBoxes = document.querySelectorAll('.ballot-box');
            ballotBoxes.forEach(box => box.disabled = true);

            // Show the ballot selection buttons
            const ballotButtons = document.getElementById('ballot-buttons');
            ballotButtons.style.display = 'block';

            // Hide the finalize candidate button
            const finalizeCandidateButton = document.getElementById('finalize-candidate-button');
            finalizeCandidateButton.style.display = 'none';

            // Show the finalize receipt button container
            const receiptButtonContainer = document.getElementById('receipt-button-container');
            receiptButtonContainer.style.display = 'flex'; // Ensure 'flex' for proper centering
        }

        function finalizeReceipt() {
            // Hide all ballots except the selected one
            const selectedBallotNumber = document.querySelector('.receipt-button[style*="background: rgb(69, 160, 73);"]').id.slice(-1);
            const booleanArray = [];
            const ballotCheckboxes = document.querySelectorAll(`td:nth-child(${parseInt(selectedBallotNumber) + 1}) .ballot-box`);

            ballotCheckboxes.forEach(checkbox => {
                booleanArray.push(checkbox.checked);
            });

            // Find the corresponding ballot from ballotAttributes
            const selectedBallot = attributes[selectedBallotNumber - 1]; // Adjust index for 0-based array
            const ballotId = selectedBallot.id;
            const candidateOrder = selectedBallot["candidateOrder"];

            const ballotColumns = document.querySelectorAll('td:nth-child(n+2)');
            ballotColumns.forEach((column, index) => {
                if ((index % 3) + 1 != selectedBallotNumber) {
                    column.style.display = 'none';
                }
            });

            // Hide ballot headers except for the selected one
            const ballotHeaders = document.querySelectorAll('th:nth-child(n+2)');
            ballotHeaders.forEach((header, index) => {
                if ((index % 3) + 1 != selectedBallotNumber) {
                    header.style.display = 'none';
                }
            });

            // Show Ballot ID and Candidate Order columns
            document.getElementById('ballot-id-value').textContent = ballotId;
            document.getElementById('candidate-order-value').textContent = candidateOrder;
            document.getElementById('marked-boxes').textContent = JSON.stringify(booleanArray);
            document.getElementById('additional-info').style.display = 'block';

            // Hide ballot selection buttons
            const ballotButtons = document.getElementById('ballot-buttons');
            ballotButtons.style.display = 'none';

            // Hide submit button
            const finalizeReceiptButton = document.getElementById('finalize-receipt-button');
            finalizeReceiptButton.style.display = 'none';

            // Hide the help link
            const helpLink = document.querySelector('.help-link');
            helpLink.style.display = 'none';

            fetch('/submit-ballot-transactions', {
                method: 'POST',
                body: {"ballot1": "test1", // TODO change the values to contain actual ballot data
                    "ballot2": "test2",
                    "ballot3": "test3"},
            })
                .then(response => response.json())  // assuming the server returns JSON
                .then(data => {
                    console.log('Success:', data);
                    // Handle success - update DOM without reloading
                    alert("Ballots cast to the blockchain");
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }

        function selectBallot(ballotNumber) {
            const receiptButtons = document.querySelectorAll('.receipt-button');
            receiptButtons.forEach(button => {
                if (button.id !== ("rButton" + ballotNumber)) {
                    button.style.background = 'gray';
                } else {
                    button.style.background = '#45a049' //green
                }
            });

            const submitButton = document.getElementById('finalize-receipt-button');
            submitButton.disabled = false;
            submitButton.style.background = 'blue';
            submitButton.style.cursor = 'pointer';
        }

        function handleCheckboxClick(checkbox) {
            if (checkbox.checked) {
                onCheck(checkbox);
            } else {
                onUncheck();
            }
        }
        function onCheck(checkbox) {
            const ballotBoxes = document.querySelectorAll('.ballot-box');
            const finalizeButton = document.getElementById('finalize-candidate-button');

            ballotBoxes.forEach(box => {
                if (box !== checkbox) {
                    box.disabled = true;
                }
            });

            finalizeButton.disabled = false;
            finalizeButton.style.background = 'blue';
            finalizeButton.style.cursor = 'pointer';
        }

        function onUncheck() {
            const ballotBoxes = document.querySelectorAll('.ballot-box');
            const finalizeButton = document.getElementById('finalize-candidate-button');

            ballotBoxes.forEach(box => {
                if (box.dataset.premark === 'false') {
                    box.disabled = false;
                }
            });

            finalizeButton.disabled = true;
            finalizeButton.style.background = 'gray';
            finalizeButton.style.cursor = 'not-allowed';
        }
    </script>

</head>
<body>
    <h1 th:text="${electionName}"></h1>
    <h2>Three Ballot Candidate Selection</h2>

    <script th:inline="javascript">
        let attributes = [[${attributes}]];
    </script>

    <table>
        <thead>
        <tr>
            <th>Candidate</th>
            <th>Ballot 1</th>
            <th>Ballot 2</th>
            <th>Ballot 3</th>
        </tr>
        </thead>
        <tbody>

        <!-- Loop through candidates -->
        <tr th:each="candidate, iterStat : ${threeBallot.candidateList}">

            <td th:text="${candidate}"></td> <!-- Candidate name -->

            <!-- Loop through ballot marks for each candidate -->
            <td>
                <!-- autocomplete="off" to deal with firefox caching issue -->
                <input type="checkbox" autocomplete="off"
                       th:checked="${firstBallotMarks[iterStat.index]}"
                       th:attr="data-premark=${threeBallot.getFirstBallot().isPremark(iterStat.index)}, disabled=${threeBallot.getFirstBallot().isPremark(iterStat.index)}"
                       class="ballot-box"
                       onclick="handleCheckboxClick(this)"/>
            </td>
            <td>
                <input type="checkbox" autocomplete="off"
                       th:checked="${secondBallotMarks[iterStat.index]}"
                       th:attr="data-premark=${threeBallot.getSecondBallot().isPremark(iterStat.index)}, disabled=${threeBallot.getSecondBallot().isPremark(iterStat.index)}"
                       class="ballot-box"
                       onclick="handleCheckboxClick(this)"/>
            </td>
            <td>
                <input type="checkbox" autocomplete="off"
                       th:checked="${thirdBallotMarks[iterStat.index]}"
                       th:attr="data-premark=${threeBallot.getThirdBallot().isPremark(iterStat.index)}, disabled=${threeBallot.getThirdBallot().isPremark(iterStat.index)}"
                       class="ballot-box"
                       onclick="handleCheckboxClick(this)"/>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- Buttons for Ballot selection (initially hidden) -->
    <div id="ballot-buttons" style="display: none; margin-top: 20px;">
        <button id="rButton1" class="receipt-button" onclick="selectBallot(1)">Ballot 1</button>
        <button id="rButton2" class="receipt-button" onclick="selectBallot(2)">Ballot 2</button>
        <button id="rButton3" class="receipt-button" onclick="selectBallot(3)">Ballot 3</button>
    </div>

    <!-- Button to disable all checkboxes -->
    <div class="button-container">
        <button id="finalize-candidate-button" class="finalize-button tooltip" onclick="finalizeCandidate()" disabled data-tooltip="Must select candidate first" autocomplete="off">Submit Candidate</button>
    </div>

    <!-- Button to finalize receipt -->
    <div class="button-container" id="receipt-button-container" style="display: none;">
        <button id="finalize-receipt-button" class="finalize-button tooltip" onclick="finalizeReceipt()" disabled data-tooltip="Must select ballot first" autocomplete="off">Submit Ballot</button>
    </div>

    <div id="additional-info" style="display: none;">
        <p><strong>Ballot ID:</strong> <span id="ballot-id-value"></span></p>
        <p><strong>Candidate Order:</strong> <span id="candidate-order-value"></span></p>
        <p><strong>Marked Boxes:</strong> <span id="marked-boxes"></span></p>
        <button id="downloadReceipt" class="button">Download Receipt</button>
        <button id="emailReceipt" class="button">Email Receipt</button>
    </div>

    <a href="#" class="help-link" onclick="window.open('/instructions', '_blank')" style="margin-top: 100px;">Three-Ballot Voting Instructions</a>
    <div th:if="!${validKey}" class="keyModal">
        <div class="pop-up-container">
            <h2>Please Enter Your Signing Key</h2>
            <div th:if="${errorMessage}" class="error-message" th:text="${errorMessage}"></div>
            <form id="signingKeyForm" th:action="@{/verify-signing-key}" method="post">
                <div class="form-group">
                    <textarea class="key-input" required
                              name="key"
                              id="signingKeyInput"
                              placeholder="Enter your signing key here"
                              maxlength="226"
                    ></textarea>
                    <button type="submit" id="submit-key-btn">Submit</button>
                </div>
            </form>
        </div>
    </div>
</body>

</html>